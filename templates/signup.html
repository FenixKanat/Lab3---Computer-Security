<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Register</title>
  <link href="{{ url_for('static', filename='styles/style.css') }}" rel="stylesheet" />
</head>
<body>
  <h2>Register</h2>
  <input id="user" placeholder="Username">
  <input id="pass" placeholder="Password" type="password">

  <label for="algo">Select Hashing Algorithm:</label>
  <select id="algo">
    <option value="bcrypt">bcrypt</option>
    <option value="sha256">sha256</option>
    <option value="sha3">sha3</option>
    <option value="argon2">argon2</option>
  </select>

  <div style="margin-top:10px;">
    <label for="mfa">Multi-factor authentication (optional):</label>
    <select id="mfa">
      <option value="none">None</option>
      <option value="totp">TOTP (Time-based)</option>
      <option value="hotp">HOTP (Counter-based)</option>
    </select>
  </div>

  <button onclick="register()">Register</button>
  <button id="regPasskeyBtn" onclick="registerPasskey()" hidden>Register a Passkey</button>
  <a href="{{ url_for('home') }}" class="button-link" id="backLink">Back to Login</a>

  <div id="mfaEnroll" style="display:none; margin-top:1rem;">
    <h3>MFA Enrollment</h3>
    <div id="mfaMsg"></div>
    <div id="qrBox" style="margin-top:.5rem;"></div>
    <p style="margin-top:.5rem;">
      <small>
        Scan the QR with your authenticator (e.g., Google Authenticator, Authy, Microsoft Authenticator).
        If it doesn’t scan, you can enter the secret manually.
      </small>
    </p>
  </div>

  <pre id="result"></pre>

  <script>
    // IMPORTANT: use http://localhost:5000 so WebAuthn RP-ID/origin match.
    const base = "http://localhost:5000";

    function b64urlToBuf(b64url) {
      const pad = '='.repeat((4 - b64url.length % 4) % 4);
      const b64 = (b64url + pad).replace(/-/g, '+').replace(/_/g, '/');
      const raw = atob(b64);
      const buf = new ArrayBuffer(raw.length);
      const bytes = new Uint8Array(buf);
      for (let i = 0; i < raw.length; ++i) bytes[i] = raw.charCodeAt(i);
      return buf;
    }
    function bufToB64url(buf) {
      const bytes = new Uint8Array(buf);
      let s = '';
      for (const b of bytes) s += String.fromCharCode(b);
      return btoa(s).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
    }

    async function register() {
      const username = document.getElementById("user").value;
      const password = document.getElementById("pass").value;
      const algo = document.getElementById("algo").value;
      const mfaChoice = document.getElementById("mfa").value;

      const res = await fetch(`${base}/register`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ username, password, algo })
      });

      const text = await res.text();
      document.getElementById("result").textContent = text;

      if (res.status === 201) {
        // show Passkey button
        document.getElementById("regPasskeyBtn").hidden = false;
        // enroll OTP if chosen
        if (mfaChoice !== "none") {
          enrollMFA(username, mfaChoice);
        }
      }
    }

    async function enrollMFA(username, type) {
      document.getElementById("mfaEnroll").style.display = "block";
      document.getElementById("mfaMsg").textContent = `Enrolling ${type.toUpperCase()} for ${username}...`;
      document.getElementById("qrBox").textContent = "";

      const res = await fetch(`${base}/mfa/enroll`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ username, type })
      });
      const json = await res.json();

      if (res.status === 200) {
        document.getElementById("mfaMsg").textContent = `${type.toUpperCase()} enrolled. Scan the QR below:`;
        document.getElementById("qrBox").innerHTML = `
          <img src="${json.qr_data_url}" alt="QR" style="max-width:100%; border:1px solid #ddd; border-radius:8px;">
          <div style="word-break:break-all; margin-top:.5rem;"><small>Secret: ${json.secret}</small></div>
        `;
        document.getElementById("backLink").scrollIntoView({ behavior: "smooth" });
      } else {
        document.getElementById("mfaMsg").textContent = "MFA enrollment failed:";
        document.getElementById("qrBox").textContent = JSON.stringify(json, null, 2);
      }
    }

    // ----- WebAuthn: Register Passkey -----
    async function registerPasskey() {
      const username = document.getElementById("user").value;
      if (!username) {
        alert("Enter the same username you just registered first.");
        return;
      }
      // Get creation options from server
      const optRes = await fetch(`${base}/webauthn/register/options`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username })
      });
      const options = await optRes.json();

      // Fix binary fields → ArrayBuffers
      options.challenge = b64urlToBuf(options.challenge);
      options.user.id = b64urlToBuf(options.user.id);
      if (Array.isArray(options.excludeCredentials)) {
        options.excludeCredentials = options.excludeCredentials.map(c => ({
          ...c, id: b64urlToBuf(c.id)
        }));
      }

      // Create credential
      const cred = await navigator.credentials.create({ publicKey: options });

      // Package results → base64url
      const credential = {
        id: cred.id,
        type: cred.type,
        rawId: bufToB64url(cred.rawId),
        response: {
          attestationObject: bufToB64url(cred.response.attestationObject),
          clientDataJSON: bufToB64url(cred.response.clientDataJSON),
          transports: cred.response.getTransports ? cred.response.getTransports() : []
        },
        clientExtensionResults: cred.getClientExtensionResults?.() || {},
        authenticatorAttachment: cred.authenticatorAttachment || null
      };

      const verifyRes = await fetch(`${base}/webauthn/register/verify`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ username, credential })
      });
      const verifyJson = await verifyRes.json();
      document.getElementById("result").textContent = JSON.stringify(verifyJson, null, 2);
    }
  </script>
</body>
</html>
